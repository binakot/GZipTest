# :two: Вторая итерация разработки

## Комментарии к [первой реализации](release-0.1.md)

* Пересоздание потоков, а так же их перезапуск для каждого блока – это не эффективно.
* Чтение файла из каждого потока, так же как и чтение по мере необходимости – не эффективно.
* Синхронизация вида «while(…) { }» - нагружает процессор и отнимает у него массу ресурсов. 
* Выбранная схема распараллеливания неэффективна – при параллельном чтении/записи в несколько потоков в случае обычного HDD производительность будет только деградировать.

## Выводы

В первую очередь скажу, что все замечания абсолютно справедливы. 
А также хочется выразить благодарность за возможность доработки реализации.
Итак, что следует исправить...

> Пересоздание потоков, а так же их перезапуск для каждого блока – это не эффективно

Не пересоздавать потоки! 
Создаем нужные потоки при запуске приложения и стараемся максимально их переиспользовать.
[ThreadPool](https://msdn.microsoft.com/en-us/library/system.threading.threadpool(v=vs.90).aspx) использовать нельзя.
Поэтому реализуем базовый Worker, от него наследуем более специфичные Worker'ы для конкретных задач (чтение, запись, компрессия/декомпрессия).

> Чтение файла из каждого потока, так же как и чтение по мере необходимости – не эффективно

Как написано выше, реализуем для чтения и записи отдельные Worker'ы. 
Один Worker для чтения из входного файла в буфер для дальнейшей обработки.
Другой Worker для записи уже обработанных данных в выходной файл.
И несколько Worker'ом для компрессии/декомпрессии.

> Синхронизация вида «while(…) { }» - нагружает процессор и отнимает у него массу ресурсов. 

Делаем все по-нормальному. Реализуем синхронизацию Worker'ов с помощью 
[lock](https://msdn.microsoft.com/en-us/library/c5kehkcz(v=vs.90).aspx),
[Monitor](https://msdn.microsoft.com/en-us/library/system.threading.monitor(v=vs.90).aspx),
[ManualResetEvent](https://msdn.microsoft.com/en-us/library/system.threading.manualresetevent(v=vs.90).aspx),
[AutoResetEvent](https://msdn.microsoft.com/en-us/library/system.threading.autoresetevent(v=vs.90).aspx).

> Выбранная схема распараллеливания неэффективна – при параллельном чтении/записи в несколько потоков в случае обычного HDD производительность будет только деградировать.

Читаем из файла одним потоком, пишем в файл одним потоком.

## Реализация 

TODO